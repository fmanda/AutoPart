CREATE FUNCTION [dbo].[FN_SLIP_SALESRETUR](
	@RETURID INT
)RETURNS TABLE
AS RETURN
SELECT A.ID, A.REFNO, A.TRANSDATE, A.DUEDATE, E.INVOICENO,
CASE WHEN (A.RETURFLAG = 1) THEN 'PEMBATALAN' ELSE 'RETUR PENJUALAN' END AS JENIS,
(A.AMOUNT - A.PPN) AS SUBTOTAL, A.PPN, A.AMOUNT, A.NOTES, 
A.MODIFIEDBY, A.MODIFIEDDATE, B.NAMA AS CUSTOMER, B.ALAMAT AS ALAMAT,
C.NAMA AS SALESMAN, D.NAMA AS WAREHOUSE, D.NAMA AS MEKANIK, DET.*
FROM TSALESRETUR A
INNER JOIN TCUSTOMER B ON A.CUSTOMER_ID = B.ID
LEFT JOIN TSALESMAN C ON A.SALESMAN_ID = C.ID
LEFT JOIN TWAREHOUSE D ON A.WAREHOUSE_ID = D.ID
LEFT JOIN TSALESINVOICE E ON E.ID = A.INVOICE_ID
INNER JOIN
(
	SELECT A.ID AS RETUR_ID, C.KODE, C.NAMA, D.UOM, ABS(B.QTY) AS QTY, B.HARGA, B.DISCOUNT,
	ABS(B.QTY)*(B.HARGA-B.DISCOUNT) AS LINETOTAL
	FROM TSALESRETUR A
	INNER JOIN TTRANSDETAIL B ON A.ID = B.HEADER_ID AND B.HEADER_FLAG = 250
	INNER JOIN TITEM C ON C.ID = B.ITEM_ID 
	INNER JOIN TUOM D ON D.ID = B.UOM_ID
	WHERE A.ID = @RETURID
		
) AS DET ON DET.RETUR_ID = A.ID
WHERE A.ID = @RETURID
GO


CREATE FUNCTION [dbo].[FN_SLIP_PURCHASERETUR](
	@RETURID INT
)RETURNS TABLE
AS RETURN
SELECT A.ID, A.REFNO, A.TRANSDATE, A.DUEDATE, F.INVOICENO, 
F.REFERENSI, (A.AMOUNT - A.PPN) AS SUBTOTAL, A.PPN, A.AMOUNT, A.NOTES, 
A.MODIFIEDBY, A.MODIFIEDDATE, B.KODE AS KODESUPPLIER, 
B.NAMA AS SUPPLIER, B.ALAMAT AS ALAMAT, 
E.NAMA AS WAREHOUSE, DET.*
FROM TPURCHASERETUR A
INNER JOIN TSUPPLIER B ON A.SUPPLIER_ID = B.ID
LEFT JOIN TWAREHOUSE E ON A.WAREHOUSE_ID = E.ID
LEFT JOIN TPURCHASEINVOICE F ON F.ID = A.INVOICE_ID
INNER JOIN
(
	SELECT A.ID AS RETUR_ID, C.KODE, C.NAMA, D.UOM, ABS(B.QTY) AS QTY, B.HARGA, B.DISCOUNT,
	ABS(B.QTY)*(B.HARGA-B.DISCOUNT) AS LINETOTAL
	FROM TPURCHASERETUR A
	INNER JOIN TTRANSDETAIL B ON A.ID = B.HEADER_ID AND B.HEADER_FLAG = 150
	INNER JOIN TITEM C ON C.ID = B.ITEM_ID 
	INNER JOIN TUOM D ON D.ID = B.UOM_ID
	WHERE A.ID = @RETURID	
) AS DET ON DET.RETUR_ID = A.ID
WHERE A.ID = @RETURID
GO

