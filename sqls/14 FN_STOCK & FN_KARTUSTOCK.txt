CREATE FUNCTION FN_STOCK(	
	@ENDDATE DATE
)RETURNS @RESULT TABLE(
	ITEM_ID INT,
	QTYPCS FLOAT,
	WAREHOUSE_ID INT
) AS
BEGIN
	DECLARE @STARTDATE DATE = DATEADD(yy, DATEDIFF(yy, 0, @ENDDATE), 0)
	INSERT @RESULT(ITEM_ID, QTYPCS, WAREHOUSE_ID)
	SELECT ITEM_ID, SUM(QTY*KONVERSI), WAREHOUSE_ID 
	FROM TTRANSDETAIL
	WHERE TRANSDATE BETWEEN @STARTDATE AND @ENDDATE
	GROUP BY ITEM_ID, WAREHOUSE_ID
	RETURN
END


CREATE FUNCTION [dbo].[FN_STOCK_BYITEM](	
	@ITEMID INT,
	@ENDDATE DATE
)RETURNS @RESULT TABLE(
	ITEM_ID INT,
	QTYPCS FLOAT,
	WAREHOUSE_ID INT
) AS
BEGIN
	DECLARE @STARTDATE DATE = DATEADD(yy, DATEDIFF(yy, 0, @ENDDATE), 0)
	INSERT @RESULT(ITEM_ID, QTYPCS, WAREHOUSE_ID)
	SELECT ITEM_ID, SUM(QTY*KONVERSI), WAREHOUSE_ID 
	FROM TTRANSDETAIL
	WHERE ITEM_ID = @ITEMID
	AND TRANSDATE BETWEEN @STARTDATE AND @ENDDATE
	GROUP BY ITEM_ID, WAREHOUSE_ID
	RETURN
END

CREATE FUNCTION [dbo].[FN_KARTU_STOCK](
	@ITEM_ID INT,
	@TGLAWAL DATE,
	@TGLAKHIR DATE,
	@WAREHOUSE_ID INT	
)RETURNS @RESULT TABLE(	
	TRANSDATE DATE,
	ITEM_ID INT,
	QTYPCS FLOAT,
	HEADER_ID INT,
	HEADER_FLAG INT ,
	REFNO VARCHAR(30),
	NOTES VARCHAR(300)
) AS
BEGIN
	DECLARE @SALDOAKHIRDATE DATE = DATEADD(DAY,- 1, @TGLAWAL);

	INSERT INTO @RESULT(TRANSDATE, ITEM_ID, QTYPCS, NOTES)
	SELECT @TGLAWAL, ITEM_ID, SUM(QTYPCS), 'Saldo Awal : ' + CONVERT(varchar, @TGLAWAL, 23)
	FROM FN_STOCK_BYITEM(@ITEM_ID, @SALDOAKHIRDATE)
	WHERE (WAREHOUSE_ID = @WAREHOUSE_ID OR @WAREHOUSE_ID = 0)
	GROUP BY ITEM_ID

	--MUTASI
	INSERT INTO @RESULT(TRANSDATE, ITEM_ID, QTYPCS, HEADER_ID, HEADER_FLAG, REFNO, NOTES)
	SELECT A.TRANSDATE, A.ITEM_ID, SUM(A.QTY*A.KONVERSI), A.HEADER_ID, A.HEADER_FLAG, A.REFNO, B.TRANSNAME
	FROM TTRANSDETAIL A
	LEFT JOIN THEADERFLAG B ON A.HEADER_FLAG = B.HEADER_FLAG
	WHERE A.ITEM_ID = @ITEM_ID
	AND (A.WAREHOUSE_ID = @WAREHOUSE_ID OR @WAREHOUSE_ID = 0)
	AND A.TRANSDATE BETWEEN @TGLAWAL AND @TGLAKHIR
	GROUP BY A.TRANSDATE, A.ITEM_ID, A.HEADER_ID, A.HEADER_FLAG, A.REFNO, B.TRANSNAME	

	RETURN

END
