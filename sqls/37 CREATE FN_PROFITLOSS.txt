CREATE FUNCTION FN_PROFITLOSS(
	@START DATE,
	@END DATE
)RETURNS @RESULT TABLE(
	REPORTNAME VARCHAR(100),
	REPORTVAL FLOAT,
	REPORTGROUP SMALLINT -- 1 NETSALES, 2 COGS, 3 EXPENSE, 4 OTHER INCOME, 5 NETPROFIT, 100,200,dst HEADER LV 1
) AS
BEGIN
	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select 'INCOME',NULL, 100

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	SELECT '     Penjualan Kotor', SUM(ABS(A.QTY*A.HARGA)) AS GROSSALES, 1
	FROM TTRANSDETAIL A
	WHERE A.HEADER_FLAG = 200 AND A.TRANSDATE BETWEEN @START AND @END

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	SELECT '     Retur Penjualan', SUM(-1* ABS(A.QTY*A.HARGA)) AS RETUR, 1
	FROM TTRANSDETAIL A
	WHERE A.HEADER_FLAG = 250 AND A.TRANSDATE BETWEEN @START AND @END

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	SELECT '     Diskon Penjualan', SUM(-1* ABS(A.QTY*A.DISCOUNT)) AS RETUR, 1
	FROM TTRANSDETAIL A
	WHERE A.HEADER_FLAG = 250 AND A.TRANSDATE BETWEEN @START AND @END

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select 'TOTAL INCOME',sum(reportval),100
	from @RESULT where REPORTGROUP = 1

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select NULL, NULL, NULL


	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select 'COST OF GOOD SOLD',NULL, 200

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	SELECT '     Harga Pokok Penjualan', SUM(ABS(A.QTY*A.HARGAAVG)), 2
	FROM TTRANSDETAIL A
	WHERE A.HEADER_FLAG = 200 AND A.TRANSDATE BETWEEN @START AND @END

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	SELECT '     Harga Pokok Adjustment', SUM(-1* ABS(A.QTY*A.HARGAAVG)), 2
	FROM TTRANSDETAIL A
	WHERE A.HEADER_FLAG = 250 AND A.TRANSDATE BETWEEN @START AND @END


	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select 'TOTAL COST OF GOOD SOLD',sum(reportval),200
	from @RESULT where REPORTGROUP = 2

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select NULL, NULL, NULL


	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select 'GROSS PROFIT',
	(select sum(reportval) from @RESULT where REPORTGROUP = 100)
	-(select sum(reportval) from @RESULT where REPORTGROUP = 200)
	,250

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select NULL, NULL, NULL



	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select 'EXPENSE',NULL, 300

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select '     '+B.NAMA,SUM(A.AMOUNT),3
	FROM TFINANCIALTRANSACTION A
	INNER JOIN TACCOUNT B ON A.ACCOUNT_ID = B.ID
	INNER JOIN TACCOUNT C ON B.PARENT_ID = C.ID
	WHERE C.KODE = (SELECT DISTINCT(VARVALUE) FROM TVARIABLE WHERE VARNAME = 'ACCOUNT_EXPENSE')
	AND A.TRANSDATE BETWEEN @START AND @END
	GROUP BY B.NAMA

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select 'TOTAL EXPENSE',sum(reportval),300
	from @RESULT where REPORTGROUP = 3

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select NULL, NULL, NULL

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	SELECT 'OTHER INCOME', ISNULL(
	(select SUM(A.AMOUNT)
		FROM TFINANCIALTRANSACTION A
		INNER JOIN TACCOUNT B ON A.ACCOUNT_ID = B.ID
		INNER JOIN TACCOUNT C ON B.PARENT_ID = C.ID
		WHERE C.KODE = (SELECT DISTINCT(VARVALUE) FROM TVARIABLE WHERE VARNAME = 'ACCOUNT_INCOME')
	GROUP BY B.NAMA
	), 0), 400
	   	 
	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select NULL, NULL, NULL

	INSERT INTO @RESULT(REPORTNAME, REPORTVAL, REPORTGROUP)
	select 'NET PROFIT',
	(select sum(reportval) from @RESULT where REPORTGROUP = 100)
	-(select sum(reportval) from @RESULT where REPORTGROUP = 200)
	-(select sum(reportval) from @RESULT where REPORTGROUP = 300)
	+ -(select sum(reportval) from @RESULT where REPORTGROUP = 400)
	,500

	RETURN
END


