CREATE FUNCTION [dbo].[FN_AR_OUTSTANDING](	
	@REFDATE DATE
)RETURNS @RESULT TABLE(
	SALESINVOICE_ID INT,
	INVOICENO VARCHAR(30),
	CUSTOMER VARCHAR(100),
	ALAMAT VARCHAR(200),
	SALESMAN VARCHAR(100),
	TRANSDATE DATE,
	DUEDATE DATE,
	AMOUNT FLOAT,
	PAIDAMT FLOAT,
	RETURAMT FLOAT,
	REMAIN FLOAT,
	OVERDUE INT,
	JENISFEE VARCHAR(100),
	HEADERREMAIN FLOAT
) AS
BEGIN
	INSERT INTO @RESULT(SALESINVOICE_ID, INVOICENO, CUSTOMER, ALAMAT, SALESMAN,
	TRANSDATE, DUEDATE, AMOUNT, PAIDAMT, RETURAMT, REMAIN, OVERDUE, JENISFEE, HEADERREMAIN)
	SELECT A.ID, A.INVOICENO, C.NAMA , C.ALAMAT, D.NAMA, A.TRANSDATE, A.DUEDATE, 
	A.AMOUNT, SUM(ISNULL(B.AMOUNT,0)) AS PAIDAMT, SUM(ISNULL(B.RETURAMT,0)) AS RETURAMT,
	A.AMOUNT - SUM(ISNULL(B.AMOUNT,0)) - SUM(ISNULL(B.RETURAMT,0)) AS REMAIN,
	DATEDIFF(DAY, A.DUEDATE , @REFDATE) AS OVERDUE, E.NAMA AS JENISFEE,
	(A.AMOUNT - A.PAIDAMOUNT - A.RETURAMOUNT) AS HEADERREMAIN
	FROM TSALESINVOICE A
	LEFT JOIN TFINANCIALTRANSACTION B ON A.ID = B.SALESINVOICE_ID
	AND B.TRANSDATE <= @REFDATE
	LEFT JOIN TCUSTOMER C ON A.CUSTOMER_ID = C.ID
	LEFT JOIN TSALESMAN D ON A.SALESMAN_ID = D.ID
	LEFT JOIN TSETTINGFEE E ON A.SETTINGFEE_ID = E.ID
	WHERE A.TRANSDATE <= @REFDATE AND
	(ISNULL(A.PAIDOFF,0) = 0 AND ISNULL(A.PAIDOFFDATE,DATEADD(DAY, 0, 0)) <= @REFDATE)
	GROUP BY A.ID, A.INVOICENO, A.TRANSDATE, A.DUEDATE, A.AMOUNT, 
	A.PAIDAMOUNT, C.NAMA,C.ALAMAT, D.NAMA, A.RETURAMOUNT, E.NAMA

	RETURN
END
GO


