ALTER FUNCTION FN_SLIP_PURCHASEINVOICE(
	@INVID INT
)RETURNS TABLE
AS RETURN
SELECT A.ID, A.INVOICENO, A.TRANSDATE, A.DUEDATE,  A.REFERENSI,
(A.AMOUNT - A.PPN) AS SUBTOTAL, A.PPN, A.AMOUNT, A.NOTES, 
A.MODIFIEDBY, A.MODIFIEDDATE, B.KODE AS KODESUPPLIER, 
B.NAMA AS SUPPLIER, B.ALAMAT AS ALAMAT, 
E.NAMA AS WAREHOUSE, DET.*,
CASE WHEN DET.PRICELIST <> 0 THEN
(DET.PRICELIST - DET.HARGA)/DET.PRICELIST ELSE 0 END AS DISCP
FROM TPURCHASEINVOICE A
INNER JOIN TSUPPLIER B ON A.SUPPLIER_ID = B.ID
LEFT JOIN TWAREHOUSE E ON A.WAREHOUSE_ID = E.ID
INNER JOIN
(
	SELECT A.ID AS INVOICE_ID, C.KODE, C.NAMA, D.UOM, (B.QTY) AS QTY, B.HARGA, B.DISCOUNT,
	ABS(B.QTY)*(B.HARGA-B.DISCOUNT) AS LINETOTAL, 
	B.PRICELIST
	FROM TPURCHASEINVOICE A
	INNER JOIN TTRANSDETAIL B ON A.ID = B.HEADER_ID AND B.HEADER_FLAG = 100
	INNER JOIN TITEM C ON C.ID = B.ITEM_ID 
	INNER JOIN TUOM D ON D.ID = B.UOM_ID
	WHERE A.ID = @INVID	
) AS DET ON DET.INVOICE_ID = A.ID
WHERE A.ID = @INVID
GO


