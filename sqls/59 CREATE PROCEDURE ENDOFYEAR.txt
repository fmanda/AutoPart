CREATE PROCEDURE SP_ENDOFYEAR(
	@ENDDATE DATE
) AS 
BEGIN

	DECLARE @STARTDATE DATE = DATEADD(yy, DATEDIFF(yy, 0, @ENDDATE), 0);
	DECLARE @BEGINNING DATE = DATEADD(Day, 1, @ENDDATE);

	DELETE FROM TTRANSDETAIL WHERE HEADER_ID = 0 AND HEADER_FLAG = 0 AND TRANSDATE = @BEGINNING;
	INSERT INTO TTRANSDETAIL(TRANSDATE, HEADER_ID, HEADER_FLAG, ITEM_ID, UOM_ID, QTY, 
	KONVERSI, WAREHOUSE_ID, HARGAAVG, LASTCOST, HARGA, REFNO)
	SELECT @BEGINNING, 0, 0, A.ITEM_ID, ISNULL(B.UOM_ID, 1) AS UOM_ID, SUM(A.QTY*A.KONVERSI) * ISNULL(B.KONVERSI,1) AS QTYPCS,
	B.KONVERSI, A.WAREHOUSE_ID, 
	case when isnull(B.HARGAAVG, 0) = 0 then b.HARGABELI else B.HARGAAVG END as HARGAAVG,
	B.HARGABELI, B.HARGABELI, 'SALDO AWAL ' + CONVERT(varchar, @BEGINNING, 23)
	FROM TTRANSDETAIL A
	LEFT JOIN (
		SELECT DISTINCT IU.ITEM_ID, IU.UOM_ID, IU.KONVERSI, IU.HARGAAVG, IU.HARGABELI
		FROM TITEM I INNER JOIN TITEMUOM IU ON I.ID = IU.ITEM_ID AND I.STOCKUOM_ID = IU.UOM_ID
	) B ON A.ITEM_ID = B.ITEM_ID  
	WHERE A.TRANSDATE BETWEEN @STARTDATE AND @ENDDATE
	GROUP BY A.ITEM_ID, A.WAREHOUSE_ID, B.KONVERSI, B.HARGAAVG, B.HARGABELI, B.UOM_ID;

	DELETE FROM TFINANCIALTRANSACTION WHERE HEADER_ID = 0 AND HEADER_FLAG = 0 AND TRANSDATE = @BEGINNING;

	INSERT INTO TFINANCIALTRANSACTION(
		TRANSDATE, HEADER_ID, HEADER_FLAG, REKENING_ID, DEBETAMT, CREDITAMT, REFNO, NOTES,
		AMOUNT, RETURAMT)
	SELECT @BEGINNING , 0, 0, A.REKENING_ID, SUM(A.DEBETAMT - A.CREDITAMT) AS DEBET, 0, 
	'SALDO AWAL ' + CONVERT(varchar, @BEGINNING, 23), 'SALDO AWAL ' + CONVERT(varchar, @BEGINNING, 23),
	SUM(A.DEBETAMT - A.CREDITAMT), SUM(A.DEBETAMT - A.CREDITAMT)
	FROM TFINANCIALTRANSACTION A
	INNER JOIN TREKENING B ON A.REKENING_ID = B.ID
	WHERE A.TRANSDATE BETWEEN @STARTDATE AND @ENDDATE
	GROUP BY A.REKENING_ID

END

