CREATE FUNCTION [dbo].[FN_AP_OUTSTANDING](	
	@REFDATE DATE
)RETURNS @RESULT TABLE(
	PURCHASEINVOICE_ID INT,
	INVOICENO VARCHAR(30),
	REFERENSI VARCHAR(30),
	SUPPLIER VARCHAR(100),
	TRANSDATE DATE,
	DUEDATE DATE,
	AMOUNT FLOAT,
	PAIDAMT FLOAT,
	RETURAMT FLOAT,
	REMAIN FLOAT,
	OVERDUE INT,
	HEADERREMAIN FLOAT
) AS
BEGIN
	INSERT INTO @RESULT(PURCHASEINVOICE_ID, INVOICENO, REFERENSI, SUPPLIER, TRANSDATE, DUEDATE, 
	AMOUNT, PAIDAMT, RETURAMT, REMAIN, OVERDUE, HEADERREMAIN)
	SELECT A.ID, A.INVOICENO, A.REFERENSI, C.NAMA AS SUPPLIER, A.TRANSDATE, A.DUEDATE, 
	A.AMOUNT, SUM(ISNULL(B.AMOUNT,0)) AS PAIDAMT, SUM(ISNULL(B.RETURAMT,0)) AS RETURAMT,
	A.AMOUNT - SUM(ISNULL(B.AMOUNT,0)) - SUM(ISNULL(B.RETURAMT,0)) AS REMAIN,
	DATEDIFF(DAY, A.DUEDATE , @REFDATE) AS OVERDUE,
	(A.AMOUNT - A.PAIDAMOUNT - A.RETURAMOUNT) AS HEADERREMAIN
	FROM TPURCHASEINVOICE A
	LEFT JOIN TFINANCIALTRANSACTION B ON A.ID = B.PURCHASEINVOICE_ID
	AND B.TRANSDATE <= @REFDATE
	LEFT JOIN TSUPPLIER C ON A.SUPPLIER_ID = C.ID
	WHERE A.TRANSDATE <= @REFDATE AND
	(ISNULL(A.PAIDOFF,0) = 0 AND ISNULL(A.PAIDOFFDATE,DATEADD(DAY, 0, 0)) <= @REFDATE)
	GROUP BY A.ID, A.INVOICENO, A.TRANSDATE, A.DUEDATE, A.AMOUNT, 
	A.PAIDAMOUNT, C.NAMA, A.RETURAMOUNT, A.REFERENSI

	RETURN
END
GO


