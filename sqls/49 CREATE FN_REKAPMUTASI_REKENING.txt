ALTER FUNCTION [dbo].[FN_REKAPMUTASI_REKENING](
	@REKENING_ID INT,
	@TGLAWAL DATE,
	@TGLAKHIR DATE
)RETURNS @RESULT TABLE(	
	TRANSDATE DATE,
	REKENING_ID INT,	
	HEADER_FLAG INT ,
	TRANSNAME VARCHAR(100),
	TOTAL FLOAT
) AS
BEGIN
	DECLARE @SALDOAKHIRDATE DATE = DATEADD(DAY,- 1, @TGLAWAL);

	INSERT INTO @RESULT(TRANSDATE, REKENING_ID, TOTAL, HEADER_FLAG, TRANSNAME)
	SELECT @TGLAWAL, REKENING_ID, SUM(DEBET-CREDIT),0, 'Saldo Awal'
	FROM FN_SALDO_REKENING(@SALDOAKHIRDATE, @REKENING_ID)
	GROUP BY REKENING_ID

	--MUTASI GROUP
	INSERT INTO @RESULT(TRANSDATE, REKENING_ID, TOTAL, HEADER_FLAG, TRANSNAME)
	SELECT R.TRANSDATE, R.REKENING_ID, SUM(R.SALDO), R.HEADER_FLAG, 'OTHERS'
	FROM (
		SELECT A.TRANSDATE, A.REKENING_ID, ISNULL(A.DEBETAMT,0) - ISNULL(A.CREDITAMT,0) as SALDO,
		CASE WHEN A.HEADER_FLAG = 200 AND A.REFNO LIKE '%FT%' THEN '210'
		WHEN A.HEADER_FLAG = 100 AND A.REFNO LIKE '%FB%' THEN '110' ELSE A.HEADER_FLAG END AS HEADER_FLAG
		FROM TFINANCIALTRANSACTION A	
		WHERE A.REKENING_ID = @REKENING_ID	
		AND A.TRANSDATE BETWEEN @TGLAWAL AND @TGLAKHIR
	) AS R
	GROUP BY R.TRANSDATE,R.HEADER_FLAG, R.REKENING_ID
	
	

	
	UPDATE @RESULT SET TRANSNAME = 'Penjualan via Kas' where HEADER_FLAG = 200;
	UPDATE @RESULT SET TRANSNAME = 'Pembayaran Hutang Supplier' where HEADER_FLAG = 100;
	UPDATE @RESULT SET TRANSNAME = 'Pembayaran Piutang Customer' where HEADER_FLAG = 200;
	UPDATE @RESULT SET TRANSNAME = 'Transfer Antar Kas / Bank' where HEADER_FLAG = 300;
	UPDATE @RESULT SET TRANSNAME = 'Penerimaan Lain-lain' where HEADER_FLAG = 400;
	UPDATE @RESULT SET TRANSNAME = 'Pengeluaran Lain-lain' where HEADER_FLAG = 500;
	UPDATE @RESULT SET TRANSNAME = 'Pembelian via Kas' where HEADER_FLAG = 110;
	UPDATE @RESULT SET TRANSNAME = 'Penjualan via Kas' where HEADER_FLAG = 210;



	RETURN

END