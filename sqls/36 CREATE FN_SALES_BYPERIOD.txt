CREATE FUNCTION FN_SALES_BYPERIOD(@START DATE, @END DATE)  
RETURNS TABLE  
AS  
RETURN    
SELECT A.INVOICENO, A.TRANSDATE, A.DUEDATE, 
CASE WHEN A.PAYMENTFLAG = 1 THEN 'TEMPO' ELSE 'CASH' END AS PEMBAYARAN,
CASE WHEN A.SALESTYPE = 0 THEN 'FRONT END' 
WHEN A.SALESTYPE = 1 THEN 'SALESMAN'  
ELSE 'UNKNOWN' END AS JENIS, 
CASE WHEN B.PRICETYPE = 0 THEN 'UMUM' 
WHEN B.PRICETYPE = 1 THEN 'BENGKEL' 
WHEN B.PRICETYPE = 2 THEN 'GROSIR' 
WHEN B.PRICETYPE = 3 THEN 'KELILING' 
ELSE 'UNKNOWN' END AS PRICETYPE, 
E.NAMA AS CUSTOMER,
F.ALAMAT AS ALAMAT, F.NAMA AS SALESMAN,
A.AMOUNT AS TOTALFAKTUR, C.KODE AS ITEMCODE,
C.NAMA AS ITEMNAME, G.NAMA AS MERK, H.NAMA AS GROUPITEM, 
D.UOM, B.KONVERSI, ABS(B.QTY) AS QTY, B.HARGA, B.DISCOUNT, 
CAST(MONTH(A.TRANSDATE) AS VARCHAR(10))+ ' ' + UPPER(FORMAT(A.TRANSDATE, 'MMM')) AS BULAN,
YEAR(A.TRANSDATE) AS TAHUN,
FORMAT(A.TRANSDATE, 'yyy/MM') AS MONTHPERIOD,
ABS(B.QTY * B.HARGA) AS SUBTOTAL,
ABS(B.QTY * B.DISCOUNT) AS TOTALDISC,
ABS(B.QTY * (B.HARGA-B.DISCOUNT)) AS NETSALES,
ABS(B.QTY * (B.HARGA-B.DISCOUNT) * B.PPN / 100) AS PPN,
ABS(B.QTY * B.HARGAAVG) AS COGS, 
ABS(B.QTY * (B.HARGA-B.DISCOUNT)) - ABS(B.QTY * B.HARGAAVG) AS GROSSPROFIT,
(ABS(B.QTY * (B.HARGA-B.DISCOUNT)) - ABS(B.QTY * B.HARGAAVG)) / ABS(B.QTY * (B.HARGA-B.DISCOUNT)) AS GP_PERCENT
FROM TSALESINVOICE A
INNER JOIN TTRANSDETAIL B ON A.ID = B.HEADER_ID AND B.HEADER_FLAG = 200
INNER JOIN TITEM C ON B.ITEM_ID = C.ID
INNER JOIN TUOM D ON B.UOM_ID = D.ID
LEFT JOIN TCUSTOMER E ON A.CUSTOMER_ID = E.ID
LEFT JOIN TSALESMAN F ON A.SALESMAN_ID = F.ID
LEFT JOIN TMERK G ON C.MERK_ID = G.ID
LEFT JOIN TITEMGROUP H ON H.ID = C.GROUP_ID
WHERE A.TRANSDATE BETWEEN @START AND @END
