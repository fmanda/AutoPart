CREATE FUNCTION FN_LOADKKSO(
	@TGLSO DATE,
	@WAREHOUSE_ID INT
)
RETURNS TABLE AS RETURN
SELECT R.ITEM_ID, IU.UOM_ID, R.WAREHOUSE_ID, IT.KODE, IT.NAMA, TU.UOM, IU.KONVERSI,
SUM(R.QTY)/IU.KONVERSI AS QTY,  SUM(R.QTYSYS)/IU.KONVERSI AS QTYSYS,
(SUM(R.QTY)/IU.KONVERSI) - (SUM(R.QTYSYS)/IU.KONVERSI) AS VARIANT
FROM(
	SELECT A.WAREHOUSE_ID, B.ITEM_ID, SUM(B.QTY*B.KONVERSI / D.KONVERSI) AS QTY, 0.0 AS QTYSYS
	FROM TKKSO A
	INNER JOIN TKKSOITEM B ON A.ID = B.KKSO_ID
	INNER JOIN TITEM C ON B.ITEM_ID = C.ID
	INNER JOIN TITEMUOM D ON C.ID = D.ITEM_ID AND C.STOCKUOM_ID = D.UOM_ID
	WHERE ISNULL(A.STOCKOPNAME_ID,0) = 0
	AND A.TRANSDATE = @TGLSO
	AND A.WAREHOUSE_ID = @WAREHOUSE_ID
	GROUP BY A.WAREHOUSE_ID, B.ITEM_ID, D.UOM_ID, C.KODE, C.NAMA,  D.KONVERSI
	UNION ALL
	SELECT A.WAREHOUSE_ID, A.ITEM_ID, 0.0 AS QTY, A.QTYPCS as QTYSYS
	FROM FN_STOCK(@TGLSO) A
	WHERE WAREHOUSE_ID = @WAREHOUSE_ID
) AS R 
INNER JOIN TITEM IT ON R.ITEM_ID = IT.ID
INNER JOIN TUOM TU ON IT.STOCKUOM_ID = TU.ID
INNER JOIN TITEMUOM IU ON IT.ID = IU.ITEM_ID AND IT.STOCKUOM_ID = IT.STOCKUOM_ID
INNER JOIN TWAREHOUSE WH ON R.WAREHOUSE_ID = WH.ID
GROUP BY R.ITEM_ID, IU.UOM_ID, R.WAREHOUSE_ID, IT.KODE, IT.NAMA, TU.UOM, IU.KONVERSI
